{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tìm kiếm - PetRescue</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/css/DogKibbleView.css">
</head>
<body>
{% include "frontend/header.html" %}
<h1>
    Tìm thấy {{ total }} kết quả
    {% if keyword %}
    cho "{{ keyword }}"
    {% endif %}
</h1>

<!--Layout Chinh: Sidebar + contain -->
<div class="main-layout">
    <aside class="sidebar">
        <form method="get">
            <input type="hidden" name="q" value="{{ keyword }}">
            <div class="filter-section">

                <div class="filter-group">

                    <h3 class="filter-title"><span>Giá</span></h3>
                    <div style="text-align: right;">
                        <button type="submit"
                                class="btn btn-danger btn-sm rounded-1 px-3 shadow-none"
                                style="transform: none !important;">
                            Lọc
                        </button>
                    </div>

                    <div class="filter-list mt-2">
                        <label>
                            <input type="checkbox" name="price" value="0-100000"
                                   {% if "0-100000" in selected_prices %}checked{% endif %}>
                            &lt; 100,000
                        </label>
                        <label>
                            <input type="checkbox" name="price" value="100000-200000"
                                   {% if "100000-200000" in selected_prices %}checked{% endif %}>
                            100,000-200,000
                        </label>
                        <label><input type="checkbox" name="price" value="200000-300000"
                                      {% if "200000-300000" in selected_prices %}checked{% endif %}>
                            200,000 - 300,000</label>
                        <label><input type="checkbox" name="price" value="300000-400000"
                                      {% if "300000-400000" in selected_prices %}checked{% endif %}>
                            300,000 - 400,000</label>
                        <label><input type="checkbox" name="price" value="400000-500000"
                                      {% if "400000-500000" in selected_prices %}checked{% endif %}>
                            400,000 - 500,000</label>
                        <label><input type="checkbox" name="price" value="500000-600000"
                                      {% if "500000-600000" in selected_prices %}checked{% endif %}>
                            500,000 - 600,000</label>
                        <label><input type="checkbox" name="price" value="600000-700000"
                                      {% if "600000-700000" in selected_prices %}checked{% endif %}>
                            600,000 - 700,000</label>
                        <label><input type="checkbox" name="price" value="700000-800000"
                                      {% if "700000-800000" in selected_prices %}checked{% endif %}>
                            700,000 - 800,000</label>
                        <label><input type="checkbox" name="price" value="800000-900000"
                                      {% if "800000-900000" in selected_prices %}checked{% endif %}>
                            800,000 - 900,000</label>
                        <label><input type="checkbox" name="price" value="900000-1000000"
                                      {% if "900000-1000000" in selected_prices %}checked{% endif %}>
                            900,000 - 1,000,000</label>
                    </div>
                </div>

                <div class="filter-group">
                    <h3 class="filter-title">Thương Hiệu<span>-</span></h3>

                    <div class="filter-list">

                        <label>
                            <input type="checkbox" name="brand" value="Royal Canin"
                                   {% if "Royal Canin" in selected_brands %}checked{% endif %}>
                            Royal Canin
                        </label>

                        <label>
                            <input type="checkbox" name="brand" value="Zenith"
                                   {% if "Zenith" in selected_brands %}checked{% endif %}>
                            Zenith
                        </label>

                        <label>
                            <input type="checkbox" name="brand" value="Taste Of The Wild"
                                   {% if "Taste Of The Wild" in selected_brands %}checked{% endif %}>
                            Taste Of The Wild
                        </label>

                        <label>
                            <input type="checkbox" name="brand" value="Inaba"
                                   {% if "Inaba" in selected_brands %}checked{% endif %}>
                            Inaba
                        </label>

                        <label>
                            <input type="checkbox" name="brand" value="Equilibrio"
                                   {% if "Equilibrio" in selected_brands %}checked{% endif %}>
                            Equilibrio
                        </label>

                    </div>
                </div>


            </div>
        </form>
    </aside>

    <!--    Nội dung chính-->
    <div class="content">

        <!-- ✅ TOOLBAR SẮP XẾP -->
        <div class="toolbar">
            <form method="get">
                <!-- ✅ Giữ lại keyword -->
                <input type="hidden" name="q" value="{{ keyword }}">

                <!-- ✅ Giữ lại các filter đã chọn -->
                {% for p in selected_prices %}
                <input type="hidden" name="price" value="{{ p }}">
                {% endfor %}

                {% for b in selected_brands %}
                <input type="hidden" name="brand" value="{{ b }}">
                {% endfor %}

                <div class="sort-by">
                    <span>Sắp xếp theo:</span>
                    <select name="sort"
                            id="sortSelect"
                            class="form-select form-select-sm w-auto d-inline-block"
                            style="min-width: 160px;">
                        <option value="">Bán chạy</option>
                        <option value="price_asc"
                                {% if sort == "price_asc" %}selected{% endif %}>
                            Giá: Thấp đến cao
                        </option>
                        <option value="price_desc"
                                {% if sort == "price_desc" %}selected{% endif %}>
                            Giá: Cao đến thấp
                        </option>
                    </select>
                </div>
            </form>
        </div>


        <section class="row g-4 section-spacing content-padding">

            {% if products %}
            {% for product in products %}
            <div class="col-lg-3 col-md-4 col-6">
                <div class="product-card bg-white rounded shadow-sm overflow-hidden position-relative">

                    <!-- ✅ Hiển thị badge theo trạng thái -->
                    {% if product.is_expired %}
                        <div class="position-absolute top-0 end-0 m-2" style="z-index: 10;">
                            <span class="badge bg-danger">
                                <i class="bi bi-exclamation-triangle"></i> Hết hạn
                            </span>
                        </div>
                    {% elif product.is_expiring_soon %}
                        <div class="position-absolute top-0 end-0 m-2" style="z-index: 10;">
                            <span class="badge bg-warning text-dark">
                                <i class="bi bi-clock"></i> Còn {{ product.days_until_expiry }} ngày
                            </span>
                        </div>
                    {% elif product.expiry_date %}
                        <div class="position-absolute top-0 start-0 m-2" style="z-index: 10;">
                            <span class="badge bg-info text-dark" style="font-size: 0.7rem;">
                                HSD: {{ product.expiry_date|date:"d/m/Y" }}
                            </span>
                        </div>
                    {% endif %}

                    <a href="{% url 'product_detail' product.slug %}">
                        <img src="{{ product.image }}"
                             class="w-100"
                             style="height: 200px; object-fit: contain;"
                             alt="{{ product.name }}">
                    </a>

                    <div class="p-3">
                        <div class="product-header d-flex justify-content-between align-items-center">
                            <p class="small text-muted mb-0 brand-name">{{ product.brand }}</p>

                            <button class="btn-wishlist" data-id="{{ product.id }}">
                                {% if product.id in liked_ids %}
                                <i class="bi bi-heart-fill text-danger"></i>
                                {% else %}
                                <i class="bi bi-heart"></i>
                                {% endif %}
                            </button>
                        </div>


                        <p class="fw-medium small line-clamp-2">
                            {{ product.name }}
                        </p>

                        <p class="text-danger fw-bold">
                            {{ product.final_price|intcomma }}đ
                        </p>

                        <a href="{% url 'orders:buy_now' product.id %}"
                           class="btn btn-danger w-100 mt-2">
                            Mua ngay
                        </a>
                    </div>

                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted">
                Không tìm thấy sản phẩm nào phù hợp.
            </p>
            {% endif %}

        </section>

    </div>
</div>
</div>
{% include "frontend/footer.html" %}
</body>

<!-- ✅ SCRIPT LẤY CSRF TOKEN -->
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let c of cookies) {
                c = c.trim();
                if (c.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(c.slice(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie("csrftoken");
</script>

<!-- ✅ SCRIPT WISHLIST -->
<script>
    document.querySelectorAll(".btn-wishlist").forEach(btn => {
        btn.addEventListener("click", function () {
            const productId = this.dataset.id;

            fetch(`/wishlist/toggle/${productId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrftoken,
                },
            })
                .then(res => res.json())
                .then(data => {
                    const icon = this.querySelector("i");
                    if (data.liked) {
                        icon.className = "bi bi-heart-fill text-danger";
                    } else {
                        icon.className = "bi bi-heart";
                    }
                });
        });
    });
</script>

<!-- ✅ SCRIPT CHỈ CHỌN 1 CHECKBOX -->
<script>
    document.addEventListener("DOMContentLoaded", function () {

        function singleCheckbox(name) {
            document.querySelectorAll(`input[name="${name}"]`).forEach(cb => {
                cb.addEventListener("change", function () {
                    document.querySelectorAll(`input[name="${name}"]`).forEach(i => {
                        if (i !== this) i.checked = false;
                    });
                });
            });
        }

        singleCheckbox("price");
        singleCheckbox("brand");

    });
</script>

<!-- ✅ SCRIPT TỰ ĐỘNG SUBMIT KHI CHỌN SORT -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const sortSelect = document.getElementById("sortSelect");
        if (sortSelect) {
            sortSelect.addEventListener("change", function () {
                this.form.submit();
            });
        }
    });
</script>

</html>