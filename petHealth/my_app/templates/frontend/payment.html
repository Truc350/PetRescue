{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phương thức thanh toán</title>

    <!-- Bootstrap + Icon -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- CSS riêng -->
    <link rel="stylesheet" href="{% static 'css/payment.css' %}">
    <style>
        .cod-popup {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999999;
        }

        .cod-box {
            background: #fff;
            padding: 25px 30px;
            border-radius: 12px;
            width: 360px;
            text-align: center;
        }
    </style>
</head>

<body>

<div class="wrap">
    <!-- CỘT TRÁI -->
    <div class="left">
        <!-- Logo + breadcrumb -->
        <div class="text-start mb-4">
            <img src="https://res.cloudinary.com/dwnbmfhel/image/upload/v1764038017/z7195574147136_4515011aa6bd8fb3801ff37f93280684_gahjde.jpg"
                 alt="Logo" height="100">
            <nav class="breadcrumb mt-2">
                <a href="shoppingcart.html">Giỏ hàng</a> &nbsp;>&nbsp;
                <a href="delivery-info.html">Thông tin giao hàng</a> &nbsp;>&nbsp;
                <span class="current">Phương thức thanh toán</span>
            </nav>
        </div>

        <h5 class="mb-4 fw-bold">Phương Thức Thanh Toán</h5>

        <!-- FORM THANH TOÁN -->
        <form id="paymentForm" method="post" action="{% url 'orders:complete_payment' %}">
            {% csrf_token %}
            <input type="hidden" name="payment_method" id="paymentMethod" value="">
            <div class="form-check mb-3">
                <input class="form-check-input" type="radio"
                       name="payment_method"
                       id="cod"
                       value="cod"
                       required>

                <label class="form-check-label" for="cod">
                    <i class="bi bi-cash-coin me-2 text-success"></i> Thanh toán khi giao hàng (Tiền mặt)
                </label>
            </div>

            <div class="form-check mb-4">
                <input class="form-check-input" type="radio"
                       name="payment_method"
                       id="vnpay"
                       value="vnpay">
                <label class="form-check-label" for="vnpay">
                    <i class="bi bi-credit-card-2-front me-2 text-primary"></i> Thanh toán qua VNPAY
                </label>
            </div>

            <button type="button" id="btnHoanTat" class="btn btn-primary w-100">Hoàn tất đơn hàng</button>
        </form>
    </div>

    <!-- CỘT PHẢI -->
    <!-- CỘT PHẢI: hiển thị items từ order -->
    <div class="right">
        <h5 class="fw-bold mb-4">Đơn hàng của bạn</h5>

        {% for item in items %}
        <div class="d-flex align-items-center mb-3">
            <img src="{{ item.product.image }}" width="60">
            <div>
                <p>{{ item.product.name }}</p>
                <small>Số lượng: {{ item.quantity }}</small>
            </div>
            <span class="ms-auto">{{ item.price|intcomma }}₫</span>
        </div>
        {% endfor %}

        <div class="d-flex justify-content-between">
            <span>Tạm tính</span>
            <span>{{ total|intcomma }}₫</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <span>Phí vận chuyển</span><span>Miễn Phí</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between fw-bold total">
            <span>Tổng cộng</span>
            <span>{{ total|intcomma }}₫</span>
        </div>
    </div>
</div>

<!-- POPUP XÁC NHẬN COD -->
<div class="cod-popup" id="codPopup" style="display:none;">
    <div class="cod-box">
        <h5 class="text-center mb-3">Xác nhận đơn hàng</h5>
        <p>Bạn chắc chắn muốn thanh toán khi nhận hàng?</p>
        <div class="text-center mt-3">
            <button type="button" class="btn btn-success me-2" id="confirmCOD">Xác nhận</button>
            <button type="button" class="btn btn-outline-secondary" id="cancelCOD">Hủy</button>
        </div>
    </div>
</div>
<div class="vnpay-popup" id="vnpayPopup" style="display:none;">
    <div class="vnpay-box">
        <div class="text-center mb-3">
            <img src="https://tse3.mm.bing.net/th/id/OIP.kklIaX3TV97u5KnjU_Kr4wHaHa?rs=1&pid=ImgDetMain&o=7&rm=3"
                 height="40" alt="VNPAY logo">
            <h5 class="mt-3">Bạn chắc chắn muốn thanh toán VNPAY?</h5>
        </div>
        <div class="text-center mt-3">
            <button type="button" class="btn btn-success me-2" id="confirmVNPAY">Xác nhận thanh toán</button>
            <button type="button" class="btn btn-outline-secondary" id="cancelVNPAY">Hủy</button>
        </div>
    </div>
</div>


<!-- Script chỉ để bật/tắt popup -->
<script>
    const btnHoanTat = document.getElementById('btnHoanTat');
    const codPopup = document.getElementById('codPopup');
    const vnpayPopup = document.getElementById('vnpayPopup');

    btnHoanTat.addEventListener('click', () => {
        const payment = document.querySelector('input[name="payment_method"]:checked');
        if (!payment) {
            alert('Vui lòng chọn phương thức thanh toán!');
            return;
        }

        if (payment.value === 'cod') {
            codPopup.style.display = 'flex';
        } else if (payment.value === 'vnpay') {
            vnpayPopup.style.display = 'flex';
        }
    });

    document.getElementById('confirmCOD').onclick = () => {
        document.getElementById('paymentForm').submit();
    };

    document.getElementById('confirmVNPAY').onclick = () => {
        document.getElementById('paymentForm').submit();
    };

    document.getElementById('cancelCOD').onclick = () => {
        codPopup.style.display = 'none';
    };

    document.getElementById('cancelVNPAY').onclick = () => {
        vnpayPopup.style.display = 'none';
    };
</script>
</body>
</html>
