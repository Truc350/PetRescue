<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>PetRescue Header</title>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../static/css/header.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<!-- ==== HEADER TR√äN ==== -->
<div class="header-bg">
    <div class="header-wrapper">
        <header class="top-header">
            <!-- LOGO -->
            <a href="{% url 'homePage' %}">
                <div class="logo">
                    <img src="https://res.cloudinary.com/dwnbmfhel/image/upload/v1764038017/z7195574147136_4515011aa6bd8fb3801ff37f93280684_gahjde.jpg"
                         alt="Logo">
                    <h2>PetRescue</h2>
                </div>
            </a>

            <!-- THANH T√åM KI·∫æM -->
            <div class="search-container flex-grow-1 mx-4">
                <form action="{% url 'search' %}" method="get" class="w-100">
                    <div class="search-bar position-relative w-100">
                        <button type="submit"
                                class="btn position-absolute top-50 start-0 translate-middle-y ms-2 border-0 bg-transparent">
                            <i class="bi bi-search"></i>
                        </button>

                        <!--                <input id="searchInput" type="text" autocomplete="off">-->
                        <input
                                id="searchInput"
                                class="form-control ps-5"
                                type="text"
                                name="q"
                                autocomplete="off"
                                placeholder="T√¨m s·∫£n ph·∫©m..."
                                value="{{ keyword|default:'' }}"
                        >

                        <!-- Danh s√°ch g·ª£i √Ω x·ªï xu·ªëng -->
                        <ul id="suggestList" class="list-group position-absolute w-100 shadow-sm"
                            style="top: 100%; left: 0; z-index: 1000; display: none;">
                        </ul>
                        <!-- INPUT FILE ·∫®N -->
                        <input
                                type="file"
                                id="imageSearchInput"
                                accept="image/*"
                                hidden
                        >
                        <!-- N√öT CAMERA - D·ªäCH SANG TR√ÅI M·ªòT CH√öT -->
                        <button type="button"
                                class="btn position-absolute top-50 translate-middle-y border-0 bg-transparent"
                                style="right: 50px;"
                                onclick="document.getElementById('imageSearchInput').click()">
                            <i class="bi bi-camera"></i>
                        </button>
                    </div>
                </form>
            </div>


            <!-- H√ÄNH ƒê·ªòNG HEADER -->
            <div class="header-actions">
                <a href="{% url 'wishlist' %}">
                    <div class="icon-btn" title="Y√™u th√≠ch">
                        <i class="bi bi-heart"></i>
                        <span>Y√™u th√≠ch</span>
                    </div>
                </a>


                <a href="{% url 'shoppingcart' %}">
                    <div class="icon-btn" title="Gi·ªè h√†ng">
                        <i class="bi bi-cart3"></i>
                        <span>Gi·ªè h√†ng</span>
                    </div>
                </a>


                <!-- ƒê√É ƒêƒÇNG NH·∫¨P -->
                {% if user.is_authenticated %}

                <a href="{% url 'personal-page' %}" class="text-decoration-none">
                    <div class="icon-btn text-white" title="T√†i kho·∫£n">
                        <i class="bi bi-person-circle"></i>
                        <span>{{ user.username }}</span>
                    </div>
                </a>

                {% else %}

                <!-- CH∆ØA ƒêƒÇNG NH·∫¨P -->
                <a href="{% url 'login' %}" class="text-decoration-none">
                    <div class="icon-btn text-white" title="ƒêƒÉng nh·∫≠p">
                        <i class="bi bi-person-circle"></i>
                        <span>T√†i kho·∫£n</span>
                    </div>
                </a>

                {% endif %}


            </div>
        </header>
    </div>
</div>

<!-- ==== MENU D∆Ø·ªöI ==== -->
<!-- ==== MENU D∆Ø·ªöI (ƒê√É CH·ªàNH ICON) ==== -->
<div class="menu-bg">
    <div class="header-wrapper">
        <nav class="main-nav">

            <!-- DROPDOWN CH√ì -->
            <div class="dropdown-custom">
                <button class="nav-item">
                    <i class="fa-solid fa-dog"></i> Ch√≥
                </button>
                <div class="dropdown-menu-custom">
                    <div class="dropdown-column">
                        <a href="{% url 'category-detail' 'cho-food' %}"><h4>Th·ª©c ƒÇn Cho Ch√≥</h4></a>
                    </div>

                    <div class="dropdown-column">
                        <a href="{% url 'category-detail' 'cho-care' %}"><h4>ChƒÉm S√≥c V·ªá Sinh Ch√≥</h4></a>
                    </div>

                    <div class="dropdown-column">
                        <a href="{% url 'category-detail' 'cham-soc-sc-kho-cho' %}"><h4>ChƒÉm S√≥c S·ª©c Kh·ªèe Ch√≥</h4></a>
                    </div>

                </div>
            </div>

            <!-- DROPDOWN M√àO -->
            <div class="dropdown-custom">
                <button class="nav-item">
                    <i class="fa-solid fa-cat"></i> M√®o
                </button>

                <div class="dropdown-menu-custom">

                    <div class="dropdown-column">
                        <a href="{% url 'category-detail' 'meo-food' %}"><h4>Th·ª©c ƒÇn Cho M√®o</h4></a>
                    </div>

                    <div class="dropdown-column">
                        <a href="{% url 'category-detail' 'cham-soc-sc-kho-cho-meo' %}"><h4>ChƒÉm S√≥c S·ª©c Kh·ªèe Cho
                            M√®o</h4></a>
                    </div>

                    <div class="dropdown-column">
                        <a href="{% url 'category-detail' 'v-sinh-cho-meo' %}"><h4>V·ªá Sinh Cho M√®o</h4></a>
                    </div>

                </div>
            </div>


            <!-- M·ª§C ƒê∆†N B√åNH TH∆Ø·ªúNG -->
            <a href="{% url 'category' %}">
                <button class="nav-item" onclick="location.href='brand.html'">
                    <i class="bi bi-award-fill"></i> Th∆∞∆°ng hi·ªáu
                </button>
            </a>
            <a href="{% url 'promotion' %}">
                <button class="nav-item" onclick="location.href='promotion.html'">
                    <i class="bi bi-gift"></i> Khuy·∫øn m√£i
                </button>
            </a>
            <a href="{% url 'support' %}" class="text-decoration-none">
                <button class="nav-item">
                    <i class="bi bi-headset"></i> H·ªó tr·ª£
                </button>
            </a>
            <a href="{% url 'policy-purchases' %}">
                <button class="nav-item" onclick="location.href='policy.html'">
                    <i class="bi bi-journal-text"></i> Ch√≠nh s√°ch mua h√†ng
                </button>
            </a>

            <a href="{% url 'newProduct' %}">
                <button class="nav-item">
                    <i class="bi bi-stars"></i> S·∫£n ph·∫©m m·ªõi
                </button>
            </a>
            <a href="{% url 'cskm' %}">
                <button class="nav-item">
        <i class="bi bi-percent"></i> Ch√≠nh s√°ch khuy·∫øn m√£i
                </button>
            </a>
        </nav>
    </div>
</div>


<!-- N√öT CHAT N·ªîI -->
<button class="chatbox-btn" data-bs-toggle="modal" data-bs-target="#chatModal">
    <i class="fa-solid fa-paw"></i>
</button>


<!-- MODAL CHATBOX -->
<div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-end">
        <div class="modal-content chatbox-container">
            <div class="modal-header chatbox-header">
                <img src="https://res.cloudinary.com/dwnbmfhel/image/upload/v1764038017/z7195574147136_4515011aa6bd8fb3801ff37f93280684_gahjde.jpg"
                     class="chatbox-logo">
                <h5 class="modal-title">PetRescue H·ªó tr·ª£</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body chatbox-body">
                <div class="message bot-msg">
                    Xin ch√†o! üêæ PetRescue c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?
                </div>
            </div>

            <div class="modal-footer chatbox-footer">
                <input
                        id="chatInput"
                        type="text"
                        class="form-control"
                        placeholder="Nh·∫≠p tin nh·∫Øn..."
                >
                <button
                        id="sendChatBtn"
                        class="btn btn-primary"
                >
                    G·ª≠i
                </button>
            </div>


        </div>
    </div>
</div>
<!-- SCRIPT DROPDOWN T√ÅCH RA H√ÄM -->
<script>
    function initHeaderDropdown() {
        const dropdowns = document.querySelectorAll(".dropdown-custom");

        dropdowns.forEach(drop => {
            const button = drop.querySelector(".nav-item");
            const menu = drop.querySelector(".dropdown-menu-custom");

            button.addEventListener("click", (event) => {
                event.stopPropagation();

                // ƒê√≥ng h·∫øt dropdown kh√°c
                dropdowns.forEach(d => {
                    if (d !== drop) d.classList.remove("show");
                });

                // Toggle dropdown hi·ªán t·∫°i
                drop.classList.toggle("show");
            });

            menu.addEventListener("click", e => e.stopPropagation());
        });

        // Click ra ngo√†i ‚Üí ƒë√≥ng t·∫•t c·∫£
        document.addEventListener("click", () => {
            dropdowns.forEach(d => d.classList.remove("show"));
        });
    }

    // G·ªçi khi DOM load xong
    window.addEventListener("DOMContentLoaded", initHeaderDropdown);
</script>

<!-- Script g·ª≠i chi·ªÅu cao header -->
<script>
    window.onload = function () {
        const height = document.body.scrollHeight;
        parent.postMessage({type: "header-height", height}, "*");
    };
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const icon = document.getElementById("searchIcon");
        if (icon) {
            icon.addEventListener("click", function () {
                this.closest("form").submit();
            });
        }
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("searchInput");
        const list = document.getElementById("suggestList");

        let controller = null;

        // Escape regex tr√°nh l·ªói k√Ω t·ª± ƒë·∫∑c bi·ªát
        function escapeRegex(text) {
            return text.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        }

        input.addEventListener("input", function () {
            const keyword = this.value.trim();

            if (!keyword) {
                list.style.display = "none";
                list.innerHTML = "";
                return;
            }

            // H·ªßy request c≈©
            if (controller) controller.abort();
            controller = new AbortController();

            fetch(`/search/suggest/?q=${encodeURIComponent(keyword)}`, {
                signal: controller.signal
            })
                .then(res => res.json())
                .then(data => {
                    list.innerHTML = "";

                    if (!data.length) {
                        list.style.display = "none";
                        return;
                    }

                    const safeKeyword = escapeRegex(keyword);
                    const regex = new RegExp(`(${safeKeyword})`, "gi");

                    data.forEach(item => {
                        const li = document.createElement("li");
                        li.className = "list-group-item list-group-item-action";

                        // Highlight t·ª´ kh√≥a
                        li.innerHTML = item.name.replace(regex, "<strong>$1</strong>");

                        li.addEventListener("click", () => {
                            window.location.href = `/product/${item.slug}/`;
                        });

                        list.appendChild(li);
                    });

                    list.style.display = "block";
                })
                .catch(err => {
                    if (err.name !== "AbortError") {
                        console.error(err);
                    }
                });
        });

        // Click ra ngo√†i ‚Üí ·∫©n g·ª£i √Ω
        document.addEventListener("click", function (e) {
            if (!e.target.closest(".search-bar")) {
                list.style.display = "none";
            }
        });
    });
</script>
<script>
    document.getElementById("imageSearchInput").addEventListener("change", function () {
        if (!this.files.length) return;

        const formData = new FormData();
        formData.append("query_image", this.files[0]);

        fetch("/search/image/", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
            .then(res => res.json())
            .then(data => {
                Swal.close();

                if (data.success && data.url) {
                    window.location.href = data.url;
                } else {
                    Swal.fire({
                        icon: "warning",
                        title: "Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m",
                        text: data.message || "H√¨nh ·∫£nh kh√¥ng ph√π h·ª£p",
                        confirmButtonText: "Th·ª≠ ·∫£nh kh√°c",
                        confirmButtonColor: "#f27474"
                    });
                }
            })
            .catch(err => {
                Swal.close();
                console.error(err);
                Swal.fire("L·ªói", "Kh√¥ng th·ªÉ x·ª≠ l√Ω h√¨nh ·∫£nh", "error");
            });
    });
</script>


<!--X·ª≠ l√Ω chatbox-->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const chatBody = document.querySelector(".chatbox-body");
        const chatInput = document.getElementById("chatInput");
        const sendBtn = document.getElementById("sendChatBtn");

        function addMessage(text, type) {
            const div = document.createElement("div");
            div.className = `message ${type}-msg`;
            div.innerText = text;
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Hi·ªán tin nh·∫Øn ng∆∞·ªùi d√πng
            addMessage(message, "user");
            chatInput.value = "";

            fetch("/api/chat/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({message})
            })
                .then(res => res.json())
                .then(data => {
                    addMessage(data.answer, "bot");
                })
                .catch(() => {
                    addMessage("‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi h·ªá th·ªëng", "bot");
                });
        }

        sendBtn.addEventListener("click", sendMessage);

        chatInput.addEventListener("keydown", e => {
            if (e.key === "Enter") sendMessage();
        });
    });
</script>


</body>


</html>