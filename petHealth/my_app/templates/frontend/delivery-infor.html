{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Thông tin giao hàng</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/delivery-infor.css' %}">
</head>
<body>

<div class="wrap">
    <!-- TRÁI -->
    <div class="left">
        <!-- Logo + breadcrumb -->
        <div class="text-start mb-4">
            <img src="https://res.cloudinary.com/dwnbmfhel/image/upload/v1764038017/z7195574147136_4515011aa6bd8fb3801ff37f93280684_gahjde.jpg"
                 alt="Logo" height="100">

            <nav class="breadcrumb mt-2">
                <a href="{% url 'shoppingcart' %}">Giỏ hàng</a> &nbsp;>&nbsp;
                <span class="current">Thông tin giao hàng</span> &nbsp;>&nbsp;
                <span>Phương thức thanh toán</span>
            </nav>
        </div>

        <h5 class="mb-4 fw-bold">Thông tin giao hàng</h5>

        <!-- Tài khoản -->
        <div class="d-flex align-items-center mb-3">
            <div class="avatar rounded-circle d-flex justify-content-center align-items-center me-3">
                <i class="bi bi-person fs-3 text-secondary"></i>
            </div>
            <div>
                <p class="mb-0 fw-semibold">{{ request.user.get_full_name }}</p>
                <small>{{ request.user.email }}</small>
            </div>
        </div>

        <!-- FORM -->
        <form method="POST" action="{% url 'orders:checkout_shipping' %}">
            {% csrf_token %}

            <!-- Địa chỉ đã lưu -->

            <div class="mb-3">
                <input type="text" name="full_name"
                       class="form-control"
                       placeholder="Họ và tên"
                       value="{{ request.user.get_full_name }}"
                       required>
            </div>

            <div class="mb-3">
                <input type="tel" name="phone"
                       class="form-control"
                       placeholder="Số điện thoại"
                       required>
            </div>

            <div class="mb-3">
                <input type="text" name="address"
                       class="form-control"
                       placeholder="Địa chỉ cụ thể (Số nhà, đường...)"
                       required>
            </div>

            <!-- CHỈ CÓ 2 CẤP: TỈNH/THÀNH PHỐ VÀ PHƯỜNG/XÃ -->
            <div class="address-select-group mb-3">
                <!-- Hidden inputs để lưu CODE -->
                <input type="hidden" name="province_code" id="provinceCodeInput">
                <input type="hidden" name="ward_code" id="wardCodeInput">

                <!-- Select để hiển thị, value là NAME -->
                <select name="province" id="province" class="form-select" required>
                    <option value="">-- Chọn Tỉnh/Thành phố --</option>
                </select>

                <select name="ward" id="ward" class="form-select mt-2" required>
                    <option value="">-- Chọn Phường/Xã --</option>
                </select>
            </div>

            <div class="mb-3">
                <textarea name="note"
                          rows="4"
                          class="form-control"
                          placeholder="Nhập ghi chú của bạn..."></textarea>
            </div>

            <button type="submit" class="btn btn-primary w-100 mt-3">
                Tiếp tục đến phương thức thanh toán
            </button>
        </form>
    </div>

    <!-- PHẢI -->
    <div class="right">
        <h5 class="fw-bold mb-4">Đơn hàng của bạn</h5>

        {% for item in items %}
        <div class="d-flex align-items-center mb-3">
            <img src="{{ item.product.image }}" width="60" alt="{{ item.product.name }}">
            <div class="flex-grow-1 ms-3">
                <p class="mb-0">{{ item.product.name }}</p>
                <small>Số lượng: {{ item.quantity }}</small>
            </div>
            <span>{{ item.price|intcomma }}₫</span>
        </div>
        {% endfor %}

        <hr>
        <div class="d-flex justify-content-between">
            <span>Tạm tính</span>
            <span>{{ total|intcomma }}₫</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <span>Phí vận chuyển</span><span>—</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between fw-bold total fs-5">
            <span>Tổng cộng</span>
            <span>{{ total|intcomma }}₫</span>
        </div>
    </div>
</div>

<script>
// ================ API V2 (2025) - CHỈ CÓ 2 CẤP ================
const API_BASE = "https://provinces.open-api.vn/api/v2";

const provinceSelect = document.getElementById("province");
const wardSelect = document.getElementById("ward");

// 1️⃣ Load danh sách Tỉnh/Thành phố
fetch(`${API_BASE}/p/`)
    .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
    })
    .then(provinces => {
        provinces.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.name;  // ✅ VALUE LÀ TÊN
            opt.textContent = p.name;
            opt.dataset.code = p.code;  // Lưu code vào dataset
            provinceSelect.appendChild(opt);
        });
    })
    .catch(err => {
        console.error("Lỗi load tỉnh:", err);
        alert("Không thể tải danh sách tỉnh/thành phố");
    });

// 2️⃣ Khi chọn Tỉnh → load Phường/Xã
provinceSelect.addEventListener("change", () => {
    const provinceName = provinceSelect.value;
    const selectedOption = provinceSelect.options[provinceSelect.selectedIndex];
    const code = selectedOption.dataset.code;

    // Cập nhật hidden input cho province_code
    document.getElementById("provinceCodeInput").value = code || '';

    // Reset ward select
    wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
    wardSelect.disabled = true;
    document.getElementById("wardCodeInput").value = '';

    if (!code) return;

    // Load tỉnh với depth=2 để lấy tất cả wards
    fetch(`${API_BASE}/p/${code}?depth=2`)
        .then(res => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        })
        .then(data => {
            if (data.wards && data.wards.length > 0) {
                data.wards.forEach(w => {
                    const opt = document.createElement("option");
                    opt.value = w.name;  // ✅ VALUE LÀ TÊN
                    opt.textContent = w.name;
                    opt.dataset.code = w.code;  // Lưu code vào dataset
                    wardSelect.appendChild(opt);
                });
                wardSelect.disabled = false;
            } else {
                alert("Không có phường/xã cho tỉnh này");
            }
        })
        .catch(err => {
            console.error("Lỗi load phường/xã:", err);
            alert("Không thể tải danh sách phường/xã");
        });
});

// Cập nhật ward_code khi chọn ward
wardSelect.addEventListener("change", () => {
    const selectedOption = wardSelect.options[wardSelect.selectedIndex];
    const code = selectedOption.dataset.code;
    document.getElementById("wardCodeInput").value = code || '';
});

// ================ XỬ LÝ ĐỊA CHỈ ĐÃ LƯU ================
const savedAddressSelect = document.getElementById("savedAddress");
const nameInput = document.querySelector('input[name="full_name"]');
const phoneInput = document.querySelector('input[name="phone"]');
const addressInput = document.querySelector('input[name="address"]');

// Lưu data từ backend
const savedAddressesData = {};

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('#savedAddress option[value]').forEach(opt => {
        if (opt.value) {
            savedAddressesData[opt.value] = {
                phone: opt.dataset.phone || '',
                fullName: opt.dataset.fullname || '',
                address: opt.dataset.address || '',
                provinceCode: opt.dataset.provincecode || '',
                provinceName: opt.dataset.provincename || '',
                wardCode: opt.dataset.wardcode || '',
                wardName: opt.dataset.wardname || ''
            };
        }
    });
});

savedAddressSelect.addEventListener("change", () => {
    const selectedId = savedAddressSelect.value;

    if (!selectedId) {
        // Reset form
        nameInput.value = nameInput.defaultValue;
        phoneInput.value = "";
        addressInput.value = "";
        provinceSelect.value = "";
        wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
        wardSelect.disabled = true;
        document.getElementById("provinceCodeInput").value = '';
        document.getElementById("wardCodeInput").value = '';
        return;
    }

    const savedAddr = savedAddressesData[selectedId];
    if (savedAddr) {
        // Fill thông tin
        nameInput.value = savedAddr.fullName;
        phoneInput.value = savedAddr.phone;
        addressInput.value = savedAddr.address;

        // Fill tỉnh bằng TÊN
        if (savedAddr.provinceName) {
            provinceSelect.value = savedAddr.provinceName;
            document.getElementById("provinceCodeInput").value = savedAddr.provinceCode;

            // Trigger load wards
            const selectedOption = provinceSelect.options[provinceSelect.selectedIndex];
            if (selectedOption.dataset.code) {
                fetch(`${API_BASE}/p/${selectedOption.dataset.code}?depth=2`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.wards) {
                            wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
                            data.wards.forEach(w => {
                                const opt = document.createElement("option");
                                opt.value = w.name;
                                opt.textContent = w.name;
                                opt.dataset.code = w.code;
                                wardSelect.appendChild(opt);
                            });
                            wardSelect.disabled = false;

                            // Chọn ward đã lưu
                            if (savedAddr.wardName) {
                                wardSelect.value = savedAddr.wardName;
                                document.getElementById("wardCodeInput").value = savedAddr.wardCode;
                            }
                        }
                    });
            }
        }
    }
});

// ================ XỬ LÝ SUBMIT FORM ================
// Không cần code này nữa vì đã submit đúng name từ select
// và code từ hidden inputs
</script>

</body>
</html>