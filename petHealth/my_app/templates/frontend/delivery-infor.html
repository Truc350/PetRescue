{% load humanize %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Thông tin giao hàng</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/delivery-infor.css' %}">
</head>
<body>

<div class="wrap">
    <!-- TRÁI -->
    <div class="left">
        <!-- Logo + breadcrumb -->
        <div class="text-start mb-4">
            <img src="https://res.cloudinary.com/dwnbmfhel/image/upload/v1764038017/z7195574147136_4515011aa6bd8fb3801ff37f93280684_gahjde.jpg"
                 alt="Logo" height="100">

            <nav class="breadcrumb mt-2">
                <a href="{% url 'shoppingcart' %}">Giỏ hàng</a> &nbsp;>&nbsp;
                <span class="current">Thông tin giao hàng</span> &nbsp;>&nbsp;
                <span>Phương thức thanh toán</span>
            </nav>
        </div>

        <h5 class="mb-4 fw-bold">Thông tin giao hàng</h5>

        <!-- Tài khoản -->
        <div class="d-flex align-items-center mb-3">
            <div class="avatar rounded-circle d-flex justify-content-center align-items-center me-3">
                <i class="bi bi-person fs-3 text-secondary"></i>
            </div>
            <div>
                <p class="mb-0 fw-semibold">{{ request.user.get_full_name }}</p>
                <small>{{ request.user.email }}</small>
            </div>
        </div>

        <!-- FORM DUY NHẤT -->
        <form method="POST" action="{% url 'orders:checkout_shipping' %}">
            {% csrf_token %}

            <!-- Địa chỉ đã lưu -->
            <div class="mb-3">
                <select name="saved_address" id="savedAddress" class="form-select">
                    <option value="">Thêm địa chỉ mới...</option>
                    {% for addr in saved_addresses %}
                    <option value="{{ addr.id }}">
                        {{ addr.phone }} - {{ addr.address }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <input type="text" name="full_name"
                       class="form-control"
                       placeholder="Họ và tên"
                       value="{{ request.user.get_full_name }}"
                       required>
            </div>

            <div class="mb-3">
                <input type="tel" name="phone"
                       class="form-control"
                       placeholder="Số điện thoại"
                       required>
            </div>

            <div class="mb-3">
                <input type="text" name="address"
                       class="form-control"
                       placeholder="Địa chỉ cụ thể (Số nhà, đường...)"
                       required>
            </div>

            <!-- Nhóm chọn địa chỉ hành chính -->
            <div class="address-select-group mb-3">
                <select name="province" id="province" class="form-select" required>
                    <option value="">-- Chọn Tỉnh/Thành phố --</option>
                </select>

                <select name="district" id="district" class="form-select mt-2" required>
                    <option value="">-- Chọn Quận/Huyện --</option>
                </select>

                <select name="ward" id="ward" class="form-select mt-2" required>
                    <option value="">-- Chọn Phường/Xã --</option>
                </select>
            </div>

            <div class="mb-3">
                <textarea name="note"
                          rows="4"
                          class="form-control"
                          placeholder="Nhập ghi chú của bạn..."></textarea>
            </div>

            <!-- Nút chuyển sang bước thanh toán (có thể thay action nếu cần) -->
            <button type="submit" class="btn btn-primary w-100 mt-3">
                Tiếp tục đến phương thức thanh toán
            </button>
        </form>
    </div>

    <!-- PHẢI -->
    <div class="right">
        <h5 class="fw-bold mb-4">Đơn hàng của bạn</h5>

        {% for item in items %}
        <div class="d-flex align-items-center mb-3">
            <img src="{{ item.product.image }}" width="60" alt="{{ item.product.name }}">
            <div class="flex-grow-1 ms-3">
                <p class="mb-0">{{ item.product.name }}</p>
                <small>Số lượng: {{ item.quantity }}</small>
            </div>
            <span>{{ item.price|intcomma }}₫</span>
        </div>
        {% endfor %}

        <hr>
        <div class="d-flex justify-content-between">
            <span>Tạm tính</span>
            <span>{{ total|intcomma }}₫</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <span>Phí vận chuyển</span><span>—</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between fw-bold total fs-5">
            <span>Tổng cộng</span>
            <span>{{ total|intcomma }}₫</span>
        </div>
    </div>
</div>

<script>
    const provinceSelect = document.getElementById("province");
    const districtSelect = document.getElementById("district");
    const wardSelect = document.getElementById("ward");

    // Load danh sách tỉnh/thành phố
    fetch("https://provinces.open-api.vn/api/?depth=1")
        .then(res => res.json())
        .then(provinces => {
            provinces.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.code;
                opt.textContent = p.name;
                provinceSelect.appendChild(opt);
            });
        })
        .catch(err => console.error("Lỗi load tỉnh:", err));

    // Khi chọn tỉnh → load quận/huyện
    provinceSelect.addEventListener("change", () => {
        const code = provinceSelect.value;
        districtSelect.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>';
        wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
        districtSelect.disabled = true;
        wardSelect.disabled = true;

        if (!code) return;

        fetch(`https://provinces.open-api.vn/api/p/${code}?depth=2`)
            .then(res => res.json())
            .then(data => {
                data.districts.forEach(d => {
                    const opt = document.createElement("option");
                    opt.value = d.code;
                    opt.textContent = d.name;
                    districtSelect.appendChild(opt);
                });
                districtSelect.disabled = false;
            });
    });

    // Khi chọn quận/huyện → load phường/xã
    districtSelect.addEventListener("change", () => {
        const code = districtSelect.value;
        wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
        wardSelect.disabled = true;

        if (!code) return;

        fetch(`https://provinces.open-api.vn/api/d/${code}?depth=2`)
            .then(res => res.json())
            .then(data => {
                data.wards.forEach(w => {
                    const opt = document.createElement("option");
                    opt.value = w.name;
                    opt.textContent = w.name;
                    wardSelect.appendChild(opt);
                });
                wardSelect.disabled = false;
            });
    });

    // ================ XỬ LÝ ĐỊA CHỈ ĐÃ LƯU ================
    const savedAddressSelect = document.getElementById("savedAddress");
    const nameInput = document.querySelector('input[name="full_name"]');
    const phoneInput = document.querySelector('input[name="phone"]');
    const addressInput = document.querySelector('input[name="address"]');

    // Bạn cần điều chỉnh dữ liệu savedAddresses để lưu thêm code tỉnh/quận nếu muốn autofill chính xác hơn.
    // Hiện tại giữ nguyên logic cũ, chỉ autofill những field có sẵn.
    savedAddressSelect.addEventListener("change", () => {
        const selectedId = savedAddressSelect.value;
        if (!selectedId) {
            // Reset form nếu chọn "Thêm địa chỉ mới"
            nameInput.value = "{{ request.user.get_full_name }}";
            phoneInput.value = "";
            addressInput.value = "";
            provinceSelect.value = "";
            districtSelect.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>';
            wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
            districtSelect.disabled = true;
            wardSelect.disabled = true;
            return;
        }

        // Nếu backend trả thêm thông tin chi tiết địa chỉ (province name/code, district, ward...),
        // bạn có thể truyền qua data attribute hoặc xử lý ở đây.
        // Hiện tại chỉ reset và để người dùng chọn lại tỉnh/huyện/xã cho an toàn.
        // (Bạn có thể mở rộng sau nếu cần)
    });
</script>

</body>
</html>